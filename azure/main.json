{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "agriflight",
      "metadata": {
        "description": "Base name for all resources"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "allowedValues": [
        "staging",
        "prod"
      ]
    },
    "location": {
      "type": "string",
      "defaultValue": "southeastasia",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "sqlAdministratorLogin": {
      "type": "string",
      "metadata": {
        "description": "Admin login for SQL Server"
      }
    },
    "sqlAdministratorLoginPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password for SQL Server"
      }
    },
    "cfAigToken": {
      "type": "securestring",
      "metadata": {
        "description": "Cloudflare AI Gateway Token"
      }
    },
    "cfAigGatewayUrl": {
      "type": "string",
      "metadata": {
        "description": "Cloudflare AI Gateway URL"
      }
    },
    "openaiApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "OpenAI API Key"
      }
    },
    "mistralApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "Mistral API Key"
      }
    },
    "xaiApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "xAI API Key"
      }
    },
    "mongodbUri": {
      "type": "securestring",
      "metadata": {
        "description": "MongoDB Connection String"
      }
    }
  },
    "mongodbUri": {
      "type": "securestring",
      "metadata": {
        "description": "MongoDB Atlas Connection String"
      }
    }
  },
  "variables": {
    "uniqueId": "[uniqueString(resourceGroup().id, parameters('projectName'))]",
    "storageAccountName": "[format('st{0}', variables('uniqueId'))]",
    "appServicePlanName": "[format('{0}-plan-{1}', parameters('projectName'), parameters('environment'))]",
    "webAppName": "[format('{0}-web-{1}', parameters('projectName'), parameters('environment'))]",
    "sqlServerName": "[format('{0}-sql-{1}', parameters('projectName'), variables('uniqueId'))]",
    "sqlDatabaseName": "agriflight-db",
    "redisCacheName": "[format('{0}-redis-{1}', parameters('projectName'), variables('uniqueId'))]",
    "appInsightsName": "[format('{0}-insights-{1}', parameters('projectName'), parameters('environment'))]",
    "logAnalyticsWorkspaceName": "[format('{0}-logs-{1}', parameters('projectName'), variables('uniqueId'))]",
    "cdnProfileName": "[format('{0}-cdn-{1}', parameters('projectName'), parameters('environment'))]",
    "vnetName": "[format('{0}-vnet-{1}', parameters('projectName'), parameters('environment'))]",
    "vnetAddressPrefix": "10.0.0.0/16",
    "appServiceSubnetName": "AppServiceSubnet",
    "appServiceSubnetPrefix": "10.0.1.0/24",
    "privateEndpointSubnetName": "PrivateEndpointSubnet",
    "privateEndpointSubnetPrefix": "10.0.2.0/24",
    "appGatewaySubnetName": "AppGatewaySubnet",
    "appGatewaySubnetPrefix": "10.0.3.0/24",
    "nsgName": "[format('{0}-nsg-{1}', parameters('projectName'), parameters('environment'))]",
    "publicIpName": "[format('{0}-ip-{1}', parameters('projectName'), parameters('environment'))]",
    "appGatewayName": "[format('{0}-agw-{1}', parameters('projectName'), parameters('environment'))]",
    "tags": {
      "Project": "AgriFlight MAKER",
      "Environment": "[parameters('environment')]",
      "ManagedBy": "Trae-AI"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2021-02-01",
      "name": "[variables('nsgName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "securityRules": [
          {
            "name": "AllowHTTPInbound",
            "properties": {
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "80",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2021-02-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('vnetAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('appServiceSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('appServiceSubnetPrefix')]",
              "delegations": [
                {
                  "name": "delegation",
                  "properties": {
                    "serviceName": "Microsoft.Web/serverFarms"
                  }
                }
              ]
            }
          },
          {
            "name": "[variables('privateEndpointSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('privateEndpointSubnetPrefix')]",
              "privateEndpointNetworkPolicies": "Disabled"
            }
          },
          {
            "name": "[variables('appGatewaySubnetName')]",
            "properties": {
              "addressPrefix": "[variables('appGatewaySubnetPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              }
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2021-02-01",
      "name": "[variables('publicIpName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "publicIPAllocationMethod": "Static"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-04-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_GRS"
      },
      "kind": "StorageV2",
      "tags": "[variables('tags')]",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2021-02-01",
      "name": "[variables('appServicePlanName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "P1v2",
        "tier": "PremiumV2",
        "size": "P1v2",
        "family": "Pv2",
        "capacity": 1
      },
      "kind": "app",
      "tags": "[variables('tags')]",
      "properties": {
        "reserved": true
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2021-02-01",
      "name": "[variables('webAppName')]",
      "location": "[parameters('location')]",
      "kind": "app",
      "tags": "[variables('tags')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('appServiceSubnetName'))]",
        "siteConfig": {
          "linuxFxVersion": "NODE|18-lts",
          "appSettings": [
            { "name": "NODE_ENV", "value": "production" },
            { "name": "SQL_USER", "value": "[parameters('sqlAdministratorLogin')]" },
            { "name": "SQL_PASSWORD", "value": "[parameters('sqlAdministratorLoginPassword')]" },
            { "name": "SQL_DATABASE", "value": "agriflight-db" },
            { "name": "SQL_SERVER", "value": "[format('{0}.database.windows.net', variables('sqlServerName'))]" },
            { "name": "SESSION_SECRET", "value": "[uniqueString(resourceGroup().id, 'session-secret')]" },
            { "name": "APPINSIGHTS_INSTRUMENTATIONKEY", "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]" },
            { "name": "REDIS_CONNECTION_STRING", "value": "[format('{0}.redis.cache.windows.net,abortConnect=false,ssl=true,password={1}', variables('redisCacheName'), listKeys(resourceId('Microsoft.Cache/Redis', variables('redisCacheName')), '2020-12-01').primaryKey)]" },
            { "name": "CF_AIG_TOKEN", "value": "[parameters('cfAigToken')]" },
            { "name": "CF_AIG_GATEWAY_URL", "value": "[parameters('cfAigGatewayUrl')]" },
            { "name": "OPENAI_API_KEY", "value": "[parameters('openaiApiKey')]" },
            { "name": "MISTRAL_API_KEY", "value": "[parameters('mistralApiKey')]" },
            { "name": "XAI_API_KEY", "value": "[parameters('xaiApiKey')]" },
            { "name": "MONGODB_URI", "value": "[parameters('mongodbUri')]" },
            { "name": "NEXT_PUBLIC_AI_PROVIDER", "value": "xai" },
            { "name": "AGENT_ID", "value": "ag_019a20d4b1737572b6fe4eb8e100f91d" }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]",
        "[resourceId('Microsoft.Cache/Redis', variables('redisCacheName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites/slots",
      "apiVersion": "2021-02-01",
      "name": "[format('{0}/staging', variables('webAppName'))]",
      "location": "[parameters('location')]",
      "kind": "app",
      "tags": "[variables('tags')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('appServiceSubnetName'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('webAppName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2021-02-01-preview",
      "name": "[variables('sqlServerName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "administratorLogin": "[parameters('sqlAdministratorLogin')]",
        "administratorLoginPassword": "[parameters('sqlAdministratorLoginPassword')]"
      }
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2021-02-01-preview",
      "name": "[format('{0}/{1}', variables('sqlServerName'), variables('sqlDatabaseName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "S0",
        "tier": "Standard"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.Cache/Redis",
      "apiVersion": "2020-12-01",
      "name": "[variables('redisCacheName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "sku": {
          "name": "Basic",
          "family": "C",
          "capacity": 0
        },
        "enableNonSslPort": false,
        "minimumTlsVersion": "1.2"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[variables('logAnalyticsWorkspaceName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('appInsightsName')]",
      "location": "[parameters('location')]",
      "kind": "web",
      "tags": "[variables('tags')]",
      "properties": {
        "Application_Type": "web",
        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2021-02-01",
      "name": "[format('{0}-sql-pe', variables('sqlServerName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "subnet": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('privateEndpointSubnetName'))]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "sqlConnection",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]",
              "groupIds": [
                "sqlServer"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2021-02-01",
      "name": "[format('{0}-redis-pe', variables('redisCacheName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "subnet": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('privateEndpointSubnetName'))]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "redisConnection",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.Cache/Redis', variables('redisCacheName'))]",
              "groupIds": [
                "redisCache"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cache/Redis', variables('redisCacheName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/applicationGateways",
      "apiVersion": "2021-02-01",
      "name": "[variables('appGatewayName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "sku": {
          "name": "Standard_v2",
          "tier": "Standard_v2",
          "capacity": 1
        },
        "gatewayIPConfigurations": [
          {
            "name": "appGatewayIpConfig",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('appGatewaySubnetName'))]"
              }
            }
          }
        ],
        "frontendIPConfigurations": [
          {
            "name": "appGatewayFrontendIp",
            "properties": {
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              }
            }
          }
        ],
        "frontendPorts": [
          {
            "name": "port_80",
            "properties": {
              "port": 80
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "appServiceBackendPool",
            "properties": {
              "backendAddresses": [
                {
                  "fqdn": "[format('{0}.azurewebsites.net', variables('webAppName'))]"
                }
              ]
            }
          }
        ],
        "backendHttpSettingsCollection": [
          {
            "name": "appServiceHttpSettings",
            "properties": {
              "port": 80,
              "protocol": "Http",
              "cookieBasedAffinity": "Disabled",
              "pickHostNameFromBackendAddress": true,
              "requestTimeout": 20
            }
          }
        ],
        "httpListeners": [
          {
            "name": "appServiceListener",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('appGatewayName'), 'appGatewayFrontendIp')]"
              },
              "frontendPort": {
                "id": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('appGatewayName'), 'port_80')]"
              },
              "protocol": "Http"
            }
          }
        ],
        "requestRoutingRules": [
          {
            "name": "rule1",
            "properties": {
              "ruleType": "Basic",
              "httpListener": {
                "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('appGatewayName'), 'appServiceListener')]"
              },
              "backendAddressPool": {
                "id": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('appGatewayName'), 'appServiceBackendPool')]"
              },
              "backendHttpSettings": {
                "id": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('appGatewayName'), 'appServiceHttpSettings')]"
              }
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]",
        "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles",
      "apiVersion": "2020-09-01",
      "name": "[variables('cdnProfileName')]",
      "location": "Global",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "Standard_Microsoft"
      }
    },
    {
      "type": "Microsoft.Cdn/profiles/endpoints",
      "apiVersion": "2020-09-01",
      "name": "[format('{0}/{1}', variables('cdnProfileName'), variables('webAppName'))]",
      "location": "Global",
      "tags": "[variables('tags')]",
      "properties": {
        "originHostHeader": "[format('{0}.azurewebsites.net', variables('webAppName'))]",
        "isHttpAllowed": false,
        "isHttpsAllowed": true,
        "queryStringCachingBehavior": "IgnoreQueryString",
        "contentTypesToCompress": [
          "text/plain",
          "text/html",
          "text/css",
          "application/x-javascript",
          "application/javascript"
        ],
        "origins": [
          {
            "name": "webAppOrigin",
            "properties": {
              "hostName": "[format('{0}.azurewebsites.net', variables('webAppName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('cdnProfileName'))]",
        "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/autoscaleSettings",
      "apiVersion": "2015-04-01",
      "name": "[format('{0}-autoscale', variables('appServicePlanName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "name": "[format('{0}-autoscale', variables('appServicePlanName'))]",
        "targetResourceUri": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "enabled": true,
        "profiles": [
          {
            "name": "AutoCreatedScaleCondition",
            "capacity": {
              "minimum": "1",
              "maximum": "5",
              "default": "1"
            },
            "rules": [
              {
                "metricTrigger": {
                  "metricName": "CpuPercentage",
                  "metricResourceUri": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                  "timeGrain": "PT1M",
                  "statistic": "Average",
                  "timeWindow": "PT5M",
                  "timeAggregation": "Average",
                  "operator": "GreaterThan",
                  "threshold": 70
                },
                "scaleAction": {
                  "direction": "Increase",
                  "type": "ChangeCount",
                  "value": "1",
                  "cooldown": "PT5M"
                }
              },
              {
                "metricTrigger": {
                  "metricName": "CpuPercentage",
                  "metricResourceUri": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                  "timeGrain": "PT1M",
                  "statistic": "Average",
                  "timeWindow": "PT5M",
                  "timeAggregation": "Average",
                  "operator": "LessThan",
                  "threshold": 30
                },
                "scaleAction": {
                  "direction": "Decrease",
                  "type": "ChangeCount",
                  "value": "1",
                  "cooldown": "PT5M"
                }
              }
            ]
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
      ]
    }
  ],
  "outputs": {
    "webAppEndpoint": {
      "type": "string",
      "value": "[format('https://{0}.azurewebsites.net', variables('webAppName'))]"
    },
    "stagingEndpoint": {
      "type": "string",
      "value": "[format('https://{0}-staging.azurewebsites.net', variables('webAppName'))]"
    },
    "appInsightsKey": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
    }
  }
}
